<script>const BACKEND_URL="https://script.google.com/macros/s/AKfycbxRE4BwWlnYLWsSVn2k1J1DvGC6vVsS1iIIqVPuTYrlQQZKAQDbcRpmrISIxB2ZB04Fqg/exec";</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fundraising Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-20">

<script>
    // ?? PASTE DEPLOYED WEB APP URL HERE ??
    const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"; 
</script>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden">
    <div class="loader"></div>
    <p class="mt-4 font-semibold text-blue-600 animate-pulse">Processing...</p>
</div>

<!-- HEADER -->
<header class="bg-blue-700 text-white p-4 shadow-md sticky top-0 z-40">
    <div class="flex justify-between items-center max-w-lg mx-auto">
        <h1 class="font-bold text-lg cursor-pointer" onclick="router('home')">Fundraising Drive</h1>
        <div class="flex gap-4">
            <i class="fas fa-cog cursor-pointer hover:text-blue-200" onclick="openAdminAuth()"></i>
            <div class="relative cursor-pointer" onclick="router('cart')">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </div>
        </div>
    </div>
</header>

<main class="max-w-lg mx-auto min-h-screen relative">

    <!-- PAGE: HOME -->
    <section id="view-home" class="p-6 fade-in">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">Welcome!</h2>
            <div id="displayIntro" class="prose text-gray-600 mb-6 whitespace-pre-wrap">Loading...</div>
            <button onclick="router('shop')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">Start Shopping</button>
        </div>
        <div class="text-center text-xs text-gray-400">
            Current Event: <span id="displayEventName">Loading...</span>
        </div>
    </section>

    <!-- PAGE: SHOP -->
    <section id="view-shop" class="p-4 hidden fade-in">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-store"></i> Shop Items</h2>
        <div id="productList" class="grid grid-cols-1 gap-4"></div>
    </section>

    <!-- PAGE: CART -->
    <section id="view-cart" class="p-4 hidden fade-in">
        <h2 class="text-xl font-bold mb-4">Your Cart</h2>
        <div id="cartItems" class="space-y-4 mb-6"></div>
        <div id="cartSummary" class="bg-white p-4 rounded shadow hidden border-t-4 border-blue-600">
            <div class="flex justify-between font-bold text-lg mb-4">
                <span>Total:</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button onclick="router('checkout')" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg">Proceed to Checkout</button>
        </div>
    </section>

    <!-- PAGE: CHECKOUT -->
    <section id="view-checkout" class="p-4 hidden fade-in">
        <h2 class="text-xl font-bold mb-4">Payment & Submit</h2>
        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded mb-6 text-sm text-yellow-800">
            <h3 class="font-bold mb-1"><i class="fas fa-info-circle"></i> Instructions</h3>
            <p id="displayPayment" class="whitespace-pre-wrap">Loading...</p>
        </div>

        <form id="checkoutForm" onsubmit="handleSubmission(event)" class="space-y-4 bg-white p-5 rounded shadow">
            <div><label class="block text-xs font-bold text-gray-500 uppercase">Full Name</label><input type="text" name="customerName" required class="w-full p-2 border rounded mt-1 bg-gray-50"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Phone</label><input type="tel" name="contact" required class="w-full p-2 border rounded mt-1 bg-gray-50"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Email</label><input type="email" name="email" required class="w-full p-2 border rounded mt-1 bg-gray-50"></div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">I am a...</label>
                <select id="userType" name="userType" onchange="handleUserTypeChange()" required class="w-full p-2 border rounded mt-1 bg-white">
                    <option value="">Select...</option>
                    <option value="Volunteer">Volunteer</option>
                    <option value="Friend/Family">Friend of Volunteer</option>
                    <option value="Caregiver">Caregiver</option>
                    <option value="Public">Public</option>
                </select>
            </div>
            <div id="dynamicField" class="hidden">
                <label id="dynamicLabel" class="block text-xs font-bold text-gray-500 uppercase">Name</label>
                <input type="text" id="relatedName" name="relatedName" class="w-full p-2 border rounded mt-1 bg-gray-50">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Payment Screenshot</label>
                <input type="file" id="paymentProof" accept="image/*" required class="w-full text-sm text-gray-500 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 mt-4 shadow">Submit Order</button>
        </form>
    </section>

    <!-- PAGE: ADMIN DASHBOARD -->
    <section id="view-admin" class="p-4 hidden fade-in bg-gray-100 min-h-screen">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Manager Dashboard</h2>
            <button onclick="adminLogout()" class="text-red-500 text-sm font-bold">Log Out</button>
        </div>

        <!-- 1. Event Management -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold text-gray-700 mb-2 border-b pb-2">? Canvassing Event</h3>
            <p class="text-sm text-gray-500 mb-2">Current: <span id="adminEventName" class="font-mono text-black">Loading...</span></p>
            <div class="flex gap-2">
                <input type="text" id="newEventName" placeholder="New Event Name" class="flex-1 p-2 border rounded text-sm">
                <button onclick="createNewEvent()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold">Create New</button>
            </div>
        </div>

        <!-- 2. Settings Management -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h3 class="font-bold text-gray-700 mb-2 border-b pb-2">?? App Text</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-gray-500">Introduction Text</label>
                    <textarea id="editIntro" rows="3" class="w-full p-2 border rounded text-sm"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Payment Instructions</label>
                    <textarea id="editPayment" rows="3" class="w-full p-2 border rounded text-sm"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Admin PIN (Login)</label>
                    <input type="text" id="editPin" class="w-full p-2 border rounded text-sm">
                </div>
                <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Save Settings</button>
            </div>
        </div>

        <!-- 3. Product Management -->
        <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold text-gray-700 mb-2 border-b pb-2">? Manage Products</h3>
            <div id="adminProductList" class="space-y-2 mb-4"></div>
            
            <div class="bg-gray-50 p-3 rounded border">
                <p class="text-xs font-bold text-gray-500 mb-2">ADD NEW PRODUCT</p>
                <input type="text" id="newProdName" placeholder="Name" class="w-full p-2 border rounded mb-2 text-sm">
                <input type="number" id="newProdPrice" placeholder="Price" class="w-full p-2 border rounded mb-2 text-sm">
                <input type="text" id="newProdImg" placeholder="Image URL" class="w-full p-2 border rounded mb-2 text-sm">
                <button onclick="addProduct()" class="w-full bg-green-600 text-white py-2 rounded text-sm font-bold">Add Product</button>
            </div>
        </div>
    </section>

</main>

<script>
    // --- STATE ---
    let appData = { config: {}, products: [], activeEventName: '' };
    let cart = [];
    let ADMIN_PIN = null;

    window.onload = loadAppData;

    // --- API & DATA ---
    async function apiCall(action, payload = {}) {
        showLoading(true);
        try {
            const body = { action, payload, pin: ADMIN_PIN };
            if (action === 'CREATE_EVENT') body.eventName = payload; // special case fix

            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
            const json = await res.json();
            if (!json.success) throw new Error(json.message);
            return json;
        } catch (e) {
            alert("Error: " + e.message);
            throw e;
        } finally {
            showLoading(false);
        }
    }

    async function loadAppData() {
        try {
            const res = await apiCall('GET_APP_DATA');
            appData = res.data;
            updateUI();
        } catch(e) {}
    }

    function updateUI() {
        // Public UI
        document.getElementById('displayIntro').innerText = appData.config.intro || '';
        document.getElementById('displayPayment').innerText = appData.config.paymentInfo || '';
        document.getElementById('displayEventName').innerText = appData.activeEventName || 'None';
        
        // Product List
        const list = document.getElementById('productList');
        list.innerHTML = appData.products.map(p => `
            <div class="bg-white rounded-lg shadow flex overflow-hidden border border-gray-100">
                <div class="w-24 h-24 bg-gray-200 shrink-0">
                    <img src="${p.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100?text=No+Img'">
                </div>
                <div class="p-3 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-gray-800 text-sm">${p.name}</h3>
                        <span class="text-blue-600 font-bold">$${p.price}</span>
                    </div>
                    <button onclick="addToCart(${p.id})" class="self-end bg-blue-50 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-100">+ Add</button>
                </div>
            </div>
        `).join('');

        renderCart();
    }

    // --- ADMIN FUNCTIONS ---
    async function openAdminAuth() {
        const pin = prompt("Enter Admin PIN:");
        if (!pin) return;
        
        try {
            ADMIN_PIN = pin;
            await apiCall('VERIFY_ADMIN'); // Validate pin with server
            openAdminPanel();
        } catch (e) {
            ADMIN_PIN = null;
        }
    }

    function openAdminPanel() {
        router('admin');
        // Populate Admin Fields
        document.getElementById('adminEventName').innerText = appData.activeEventName;
        document.getElementById('editIntro').value = appData.config.intro || '';
        document.getElementById('editPayment').value = appData.config.paymentInfo || '';
        document.getElementById('editPin').value = appData.config.adminPin || '1234'; // Note: Server doesn't send pin back by default, you might want to handle this differently or just allow overwrite
        
        renderAdminProducts();
    }

    function renderAdminProducts() {
        const list = document.getElementById('adminProductList');
        list.innerHTML = appData.products.map((p, idx) => `
            <div class="flex justify-between items-center bg-gray-50 p-2 rounded border text-sm">
                <span>${p.name} ($${p.price})</span>
                <button onclick="deleteProduct(${idx})" class="text-red-500 font-bold px-2">X</button>
            </div>
        `).join('');
    }

    async function saveSettings() {
        const newConfig = {
            intro: document.getElementById('editIntro').value,
            paymentInfo: document.getElementById('editPayment').value,
            adminPin: document.getElementById('editPin').value
        };
        await apiCall('UPDATE_CONFIG', newConfig);
        alert("Settings Saved!");
        loadAppData();
    }

    async function addProduct() {
        const name = document.getElementById('newProdName').value;
        const price = parseFloat(document.getElementById('newProdPrice').value);
        const image = document.getElementById('newProdImg').value;
        
        if (!name || !price) return alert("Name and Price required");

        const newProd = { id: Date.now(), name, price, image };
        const newProducts = [...appData.products, newProd];
        
        await apiCall('UPDATE_PRODUCTS', newProducts);
        
        // Clear inputs
        document.getElementById('newProdName').value = '';
        document.getElementById('newProdPrice').value = '';
        document.getElementById('newProdImg').value = '';
        
        loadAppData().then(openAdminPanel); // Refresh
    }

    async function deleteProduct(index) {
        if(!confirm("Delete this product?")) return;
        const newProducts = [...appData.products];
        newProducts.splice(index, 1);
        await apiCall('UPDATE_PRODUCTS', newProducts);
        loadAppData().then(openAdminPanel);
    }

    async function createNewEvent() {
        const name = document.getElementById('newEventName').value;
        if (!name) return alert("Enter event name");
        if (!confirm("Start new event? OLD DATA WILL BE ARCHIVED.")) return;
        
        await apiCall('CREATE_EVENT', name);
        alert("Event Created!");
        loadAppData().then(openAdminPanel);
    }

    function adminLogout() {
        ADMIN_PIN = null;
        router('home');
    }

    // --- CART & ORDER ---
    function addToCart(id) {
        const p = appData.products.find(x => x.id === id);
        const exist = cart.find(x => x.id === id);
        exist ? exist.qty++ : cart.push({ ...p, qty: 1 });
        renderCart();
        
        // Simple visual feedback
        const btn = document.querySelector(`button[onclick="addToCart(${id})"]`);
        const origText = btn.innerText;
        btn.innerText = "Added";
        btn.classList.add("bg-green-100", "text-green-700");
        setTimeout(() => {
            btn.innerText = origText;
            btn.classList.remove("bg-green-100", "text-green-700");
        }, 1000);
    }

    function renderCart() {
        const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
        document.getElementById('cartTotal').innerText = `$${total.toFixed(2)}`;
        document.getElementById('cartCount').innerText = cart.reduce((sum, i) => sum + i.qty, 0);
        
        const container = document.getElementById('cartItems');
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-8">Cart is empty</p>';
            document.getElementById('cartSummary').classList.add('hidden');
        } else {
            document.getElementById('cartSummary').classList.remove('hidden');
            container.innerHTML = cart.map((item, idx) => `
                <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm border-l-4 border-blue-500">
                    <div>
                        <div class="font-bold text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">$${item.price} each</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 rounded bg-gray-200 font-bold">-</button>
                        <span class="text-sm font-bold w-4 text-center">${item.qty}</span>
                        <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 rounded bg-blue-100 text-blue-700 font-bold">+</button>
                    </div>
                </div>
            `).join('');
        }
    }

    function updateQty(idx, change) {
        cart[idx].qty += change;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
        renderCart();
    }

    function handleUserTypeChange() {
        const type = document.getElementById('userType').value;
        const field = document.getElementById('dynamicField');
        const label = document.getElementById('dynamicLabel');
        const input = document.getElementById('relatedName');

        if (type === 'Friend/Family') {
            field.classList.remove('hidden');
            label.innerText = "Name of Volunteer";
            input.required = true;
        } else if (type === 'Caregiver') {
            field.classList.remove('hidden');
            label.innerText = "Name of Trainee";
            input.required = true;
        } else {
            field.classList.add('hidden');
            input.required = false;
        }
    }

    async function handleSubmission(e) {
        e.preventDefault();
        if (cart.length === 0) return alert("Cart empty");
        if (!confirm("Submit Order?")) return;

        const form = new FormData(e.target);
        const file = document.getElementById('paymentProof').files[0];
        const base64 = await toBase64(file);

        const payload = {
            customerName: form.get('customerName'),
            contact: form.get('contact'),
            email: form.get('email'),
            userType: form.get('userType'),
            relatedName: form.get('relatedName') || 'N/A',
            cart: cart,
            totalAmount: cart.reduce((s, i) => s + (i.price * i.qty), 0),
            paymentProofBase64: base64,
            mimeType: file.type
        };

        await apiCall('SUBMIT_ORDER', payload);
        alert("Order Submitted Successfully!");
        cart = [];
        e.target.reset();
        router('home');
        renderCart();
    }

    // --- UTILS ---
    function router(view) {
        document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        window.scrollTo(0,0);
    }
    
    function showLoading(show) {
        const el = document.getElementById('loadingOverlay');
        show ? el.classList.remove('hidden') : el.classList.add('hidden');
    }

    const toBase64 = file => new Promise((res, rej) => {
        const r = new FileReader();
        r.readAsDataURL(file);
        r.onload = () => res(r.result);
        r.onerror = rej;
    });
</script>
</body>
</html>